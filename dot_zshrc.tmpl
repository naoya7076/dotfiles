# Customize to your needs...
# 自動補完を有効にする
# コマンドの引数やパス名を途中まで入力して <Tab> を押すといい感じに補完してくれる
# 例： `cd path/to/<Tab>`, `ls -<Tab>`
autoload -U compinit
compinit

# 入力したコマンドが存在せず、かつディレクトリ名と一致するなら、ディレクトリに cd する
# 例： /usr/bin と入力すると /usr/bin ディレクトリに移動
setopt auto_cd

# ↑を設定すると、 .. とだけ入力したら1つ上のディレクトリに移動できるので……
# 2つ上、3つ上にも移動できるようにする
alias ...='cd ../..'
alias ....='cd ../../..'

# cd した先のディレクトリをディレクトリスタックに追加する
# ディレクトリスタックとは今までに行ったディレクトリの履歴のこと
# `cd +<Tab>` でディレクトリの履歴が表示され、そこに移動できる
setopt auto_pushd

# pushd したとき、ディレクトリがすでにスタックに含まれていればスタックに追加しない
setopt pushd_ignore_dups

# 入力したコマンドがすでにコマンド履歴に含まれる場合、履歴から古いほうのコマンドを削除する
# コマンド履歴とは今まで入力したコマンドの一覧のことで、上下キーでたどれる
setopt hist_ignore_all_dups

alias k="kubectl"
alias g='git'
{{ if (eq .chezmoi.username "naoya.shimizu") }}
alias gsm='git switch main'
alias gpl='git pull'
{{ end }}

# peco
function peco-history-selection() {
  BUFFER=$(history -n 1 | tail -r | awk '!a[$0]++' | peco)
  CURSOR=$#BUFFER
  zle reset-prompt
}
zle -N peco-history-selection
bindkey '^R' peco-history-selection

# github cli
eval "$(gh completion -s zsh)"

# zoxide
eval "$(zoxide init zsh)"

# starship
eval "$(starship init zsh)"

{{ if (eq .chezmoi.username "naoya.shimizu") }}
# secretive
export SSH_AUTH_SOCK=/Users/naoya.shimizu/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/socket.ssh

# git gtr コマンドのfzf統合
# Option+B でブランチ名を挿入
function _gtr_insert_branch_widget() {
  # fzfでブランチを選択
  local branch
  branch=$(git gtr list --porcelain 2>/dev/null | \
    grep -v "missing" | \
    awk '{printf "%s\t%s\n", $2, $1}' | \
    fzf --height 40% --reverse \
        --preview 'git -C {1} status --short' \
        --preview-window down:5:wrap | \
    awk '{print $2}')

  # 選択されたらカーソル位置に挿入
  if [ -n "$branch" ]; then
    LBUFFER="${LBUFFER}${branch}"
  fi

  # プロンプトを再描画
  zle reset-prompt
}

# ウィジェットとして登録
zle -N _gtr_insert_branch_widget

# Option+B にバインド（^[はEsc/Altキーを表す）
bindkey '^[b' _gtr_insert_branch_widget
{{ end }}

# Go
export PATH=$PATH:$(go env GOPATH)/bin


# Warp
# subshell(https://docs.warp.dev/features/subshells#automatically-warpify-subshells)
printf '\eP$f{"hook": "SourcedRcFileForWarp", "value": { "shell": "zsh"}}\x9c'

# タブ名をカレントディレクトリに設定
function set_tab_name() {
    echo -ne "\033]0;${PWD##*/}\007"
}

# プロンプト表示の前に実行
precmd_functions+=(set_tab_name)
# コマンド実行前にも実行（コマンド名で上書きされるのを防ぐ）
preexec_functions+=(set_tab_name)

{{ if (eq .chezmoi.username "naoya7076") }}
# mise
eval "$(mise activate zsh)"
{{ end }}

# direnv
eval "$(direnv hook zsh)"

# volta
export VOLTA_FEATURE_PNPM=1
export VOLTA_HOME="$HOME/.volta"
export PATH="$VOLTA_HOME/bin:$PATH"

# claude
export PATH="$HOME/.local/bin:$PATH"
